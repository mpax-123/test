<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Case Portal with Status Management</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9f9f9;
    margin: 0; padding: 0;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
  }
  .container {
    background: white;
    margin: 50px 0;
    padding: 30px;
    border-radius: 10px;
    width: 90%;
    max-width: 650px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
  }
  h2 {
    margin-bottom: 20px;
    color: #222;
    text-align: center;
  }
  label {
    display: block;
    margin-top: 15px;
    font-weight: 600;
    color: #333;
  }
  input[type="text"], input[type="password"] {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 16px;
    box-sizing: border-box;
  }
  button {
    margin-top: 25px;
    width: 100%;
    background-color: #0066ff;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 700;
    font-size: 18px;
    cursor: pointer;
    padding: 14px;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background-color: #004ecc;
  }
  .error {
    color: red;
    margin-top: 15px;
    text-align: center;
    font-weight: 600;
  }
  .case-list {
    list-style: none;
    padding: 0;
    margin-top: 20px;
  }
  .case-list li {
    margin-bottom: 12px;
    border-bottom: 1px solid #ddd;
    padding-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .case-list a {
    color: #0066ff;
    text-decoration: none;
    font-weight: 600;
    cursor: pointer;
    flex-grow: 1;
  }
  .case-list a:hover {
    text-decoration: underline;
  }
  .status-select {
    min-width: 160px;
    font-weight: 600;
    border-radius: 6px;
    border: 1px solid #ccc;
    padding: 6px;
    cursor: pointer;
  }
  .status-New {
    background-color: #ffcc00;
    color: #333;
  }
  .status-Authorised {
    background-color: #4CAF50;
    color: white;
  }
  .status-Pending {
    background-color: #2196F3;
    color: white;
  }
  .status-Denied {
    background-color: #f44336;
    color: white;
  }
  .logout-btn {
    background-color: #d33;
    margin-top: 25px;
  }
  #addUserForm {
    margin-top: 30px;
    border-top: 1px solid #ddd;
    padding-top: 20px;
  }
  #addUserForm label {
    margin-top: 0;
  }
  #addUserSuccess {
    color: green;
    font-weight: 600;
    margin-top: 10px;
    text-align: center;
  }
</style>
</head>
<body>

<div class="container">

  <div id="loginBox">
    <h2>Case Portal Login</h2>
    <form id="loginForm">
      <label for="username">Username</label>
      <input id="username" name="username" type="text" required autocomplete="off" />
      <label for="password">Password</label>
      <input id="password" name="password" type="password" required autocomplete="off" />
      <button type="submit">Login</button>
    </form>
    <div id="loginError" class="error" style="display:none;"></div>
  </div>

  <div id="caseBox" style="display:none;">
    <h2>All Cases</h2>
    <ul id="casesList" class="case-list"></ul>

    <!-- Add User form only for admin -->
    <div id="addUserSection" style="display:none;">
      <h3>Add New User</h3>
      <form id="addUserForm">
        <label for="newUsername">New Username</label>
        <input id="newUsername" name="newUsername" type="text" required autocomplete="off" />
        <label for="newPassword">New Password</label>
        <input id="newPassword" name="newPassword" type="password" required autocomplete="off" />
        <button type="submit">Add User</button>
      </form>
      <div id="addUserSuccess" style="display:none;">User added successfully!</div>
    </div>

    <button id="logoutBtn" class="logout-btn">Logout</button>
  </div>

</div>

<script>
  const ADMIN_USERNAME = "cfletcher";
  const ADMIN_PASSWORD = "HiLLonden1!!";

  // Status options list & their class names for color coding
  const STATUS_OPTIONS = [
    {value: "New", className: "status-New"},
    {value: "Authorised", className: "status-Authorised"},
    {value: "Pending Investigation", className: "status-Pending"},
    {value: "Denied", className: "status-Denied"},
  ];

  // Load users from localStorage or initialize admin user
  function loadUsers() {
    let users = JSON.parse(localStorage.getItem("users"));
    if (!users) {
      users = {};
      users[ADMIN_USERNAME] = ADMIN_PASSWORD;
      localStorage.setItem("users", JSON.stringify(users));
    }
    return users;
  }
  function saveUsers(users) {
    localStorage.setItem("users", JSON.stringify(users));
  }

  // Load cases and their statuses
  function loadCases() {
    let cases = JSON.parse(localStorage.getItem("cases"));
    if (!cases) {
      cases = {};
      localStorage.setItem("cases", JSON.stringify(cases));
    }
    return cases;
  }
  function saveCases(cases) {
    localStorage.setItem("cases", JSON.stringify(cases));
  }

  const loginBox = document.getElementById("loginBox");
  const caseBox = document.getElementById("caseBox");
  const loginError = document.getElementById("loginError");
  const loginForm = document.getElementById("loginForm");
  const casesList = document.getElementById("casesList");
  const logoutBtn = document.getElementById("logoutBtn");
  const addUserSection = document.getElementById("addUserSection");
  const addUserForm = document.getElementById("addUserForm");
  const addUserSuccess = document.getElementById("addUserSuccess");

  let currentUser = null;

  // Check if logged in
  function checkLogin() {
    const user = localStorage.getItem("loggedInUser");
    if (user) {
      currentUser = user;
      return true;
    }
    return false;
  }

  // Render all cases with status dropdown
  function renderCases() {
    casesList.innerHTML = "";
    const cases = loadCases();

    const keys = Object.keys(cases);
    if (keys.length === 0) {
      casesList.innerHTML = "<li>No cases found.</li>";
      return;
    }

    keys.forEach(key => {
      const caseData = cases[key];
      // caseData should be { html: "...", status: "New" }
      const reportHTML = caseData.html;
      const status = caseData.status || "New";

      // Extract suspect name from HTML title
      const nameMatch = reportHTML.match(/<title>Arrest Report - (.*?)<\/title>/i);
      const suspectName = nameMatch ? nameMatch[1] : "Unknown Suspect";

      const li = document.createElement("li");

      // Link to view case in new tab
      const a = document.createElement("a");
      a.textContent = `View Case: ${suspectName}`;
      a.href = "#";
      a.onclick = () => {
        const blob = new Blob([reportHTML], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
        return false;
      };

      // Status dropdown
      const select = document.createElement("select");
      select.className = "status-select";

      STATUS_OPTIONS.forEach(opt => {
        const option = document.createElement("option");
        option.value = opt.value;
        option.textContent = opt.value;
        if (opt.value === status) option.selected = true;
        select.appendChild(option);
      });

      // Set status select color class
      function updateSelectClass() {
        STATUS_OPTIONS.forEach(opt => {
          select.classList.remove(opt.className);
        });
        const found = STATUS_OPTIONS.find(o => o.value === select.value);
        if (found) select.classList.add(found.className);
      }
      updateSelectClass();

      // When status changes, update storage
      select.addEventListener("change", () => {
        const newStatus = select.value;
        cases[key].status = newStatus;
        saveCases(cases);
        updateSelectClass();
      });

      li.appendChild(a);
      li.appendChild(select);
      casesList.appendChild(li);
    });
  }

  // Handle login submit
  loginForm.addEventListener("submit", e => {
    e.preventDefault();
    loginError.style.display = "none";

    const username = e.target.username.value.trim();
    const password = e.target.password.value.trim();

    const users = loadUsers();

    if (users[username] && users[username] === password) {
      currentUser = username;
      localStorage.setItem("loggedInUser", username);
      loginBox.style.display = "none";
      caseBox.style.display = "block";
      renderCases();

      if (username === ADMIN_USERNAME) {
        addUserSection.style.display = "block";
      } else {
        addUserSection.style.display = "none";
      }
    } else {
      loginError.textContent = "Invalid username or password.";
      loginError.style.display = "block";
    }
  });

  // Handle logout
  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("loggedInUser");
    currentUser = null;
    caseBox.style.display = "none";
    loginBox.style.display = "block";
    loginForm.reset();
    loginError.style.display = "none";
  });

  // Handle add user form submit
  addUserForm.addEventListener("submit", e => {
    e.preventDefault();
    addUserSuccess.style.display = "none";

    const newUsername = e.target.newUsername.value.trim();
    const newPassword = e.target.newPassword.value.trim();

    if (!newUsername || !newPassword) return;

    const users = loadUsers();
    if (users[newUsername]) {
      alert("User already exists!");
      return;
    }
    users[newUsername] = newPassword;
    saveUsers(users);

    addUserSuccess.style.display = "block";
    addUserForm.reset();

    // Hide success message after 3 seconds
    setTimeout(() => {
      addUserSuccess.style.display = "none";
    }, 3000);
  });

  // On page load, check login state
  window.onload = () => {
    if (checkLogin()) {
      loginBox.style.display = "none";
      caseBox.style.display = "block";
      renderCases();

      if (currentUser === ADMIN_USERNAME) {
        addUserSection.style.display = "block";
      } else {
        addUserSection.style.display = "none";
      }
    }
  };
</script>

</body>
</html>
